# О модуле
Модуль обеспечивает интеграцию Интернет-магазина со службой доставки DPD.

Обеспечивается отсылание заявок на доставку заказов, мониторинг статусов 
доставки заказов и выставление соответствующих им статусов в админке Битрикса. 
В модуле присутствует функционал печати актов и товарных накладных для заказов.

Вместе с модулем устанавливаются автоматизированные службы доставки DPD, 
позволяющие покупателям выбрать доставку курьером, или же выбрать удобный для 
них пункт самовывоза. Стоимость доставки вычисляется с помощью API DPD с учетом 
габаритов заказа и других параметров.

## Как работает модуль
Модуль создает новую автоматизированную службу доставки с кодом ***ipolh_dpd***. У службы 
есть 2 профиля: курьер (***courier***) и самовывоз (***pickup***). Они будут
отображаться на странице оформления заказа, если в выбранный пользователем город
доставки возможна доставка указанным тарифом. Эти службы доставки заметно
упрощают процесс заполнения заявки, а так же позволяют покупателю наглядно и
удобно выбрать пункт самовывоза или почтомат. Возможность доставки по выбранному
профилю, стоимость и сроки рассчитываются на стороне API DPD.

Модуль использует встроенный функционал рассчета габаритов заказа и API DPD для
вычисления стоимости доставки при оформлении заказа.

Модуль устанавливает компонент "Пункты самовывоза DPD", который отображает
детальные сведения о пунктах, и может использоваться в качестве наглядной
информации о доставке.

Заявка на доставку составляется для каждого заказа в отдельности, причем
контроль за корректностью введенных данных возлагается на пользователя. При
сохранении данные о заявке сохраняются в базу данных. При отсылании заявки
модуль формирует SOAP-запрос согласно документации DPD и отсылает его на сервер.
Результат обработки заявки приходит сразу же, выдавая либо ошибку, либо 
информацию об успешном принятии заявки. В некоторых случаях автоматическая 
обработка заявки может быть не доступна и для подтверждения заявки требуется ее 
провека менеджером со стороны DPD, в этом случае заявке может быть присвоен 
статус "Ожидает проверки"

Модуль создает на сайте агент, который должен запускаться каждые 10 минут и 
запрашивать статусы отосланных заявок. Получив ответ, модуль анализирует его и
обновляет статусы заявок в зависимости от результатов их обработки, а так же
выставляет статусы соответствующим заказам, если включена опция в настройках
модуля.

Отосланные заявки при необходимости можно отозвать и пересоздать заново.

## Начало работы
Первым делом необходимо перейти на страницу настроек модуля 
***Настройки / Настройки модулей / Интеграция DPD*** 
и указать параметры авторизации в API DPD, после этого необходимо сохранить 
форму и далее уже можно переходить к другим настройкам модуля.

Все группы настроек содержат развернутые пояснения рядом со своей группой или в
справочных ссылках.

Особое внимание следует уделить полю Город-отправитель - он должен определиться 
автоматически из настроек Интернет-магазина. Если он не определился - значит
либо указанная настройка не задана (и ее надо указать), либо в этом городе нет 
пунктов приема/выдачи DPD и необходимо будет выбрать ближайший пункт в котором 
возможна отправка.

Чтобы перевести модуль в боевой режим достаточно снять галочку "Тестовый режим"
в настройках модуля.

Не рекомендуется использовать при тестировании заказы, которые впоследствии
будут отправлены DPD.

### Настройка служб доставки
1. ***Управление службами доставки находится на странице настроек***
автоматизированных служб доставки. Здесь можно настроить:

	* Активность службы доставки и ее профилей
	* Название и описание службе доставки и ее профилям
	* Наценку на стоимость доставки
	* Привязку профилей к платежным системам
	* Ограничения по габаритам и стоимости заказа

2. ***Привязка способа оплаты к Службе Доставок.***

	Для того, чтобы привязать платежные системы к конкретным вариантам доставки
	используйте стандартный функционал Bitrix (доступен с 14-й версии) - в
	настройках платежных систем откройте нужную плат.систему и во вкладке
	***Службы доставки*** выберите службы для которых будет доступна данная
	платежная система.

3. ***Отображается кнопка расcчитать стоимость.***

	Для того, чтобы стоимость расчитывалась автоматом, необходимо в параметрах
	компонента оформления заказа (sale.order.ajax) поставить галочку
	***Рассчитывать стоимость доставки сразу***.

4. ***Не отображается срок доставки / Не отображается ссылка "Выбрать пункт самовывоза".***

	Если это происходит при выборе профиля доставки - это обычная ошибка шаблона
	оформления заказа. В этом случае необходимо поправить шаблон оформления
	заказа добавив вывод значения переменной ```$arDelivery["PERIOD_TEXT"]```.

5. ***Учет веса заказа.***

	Ограничения по весу заказа учитываются самим модулем при расчете служб
	доставки. Данные о весе товара берутся только из торгового каталога. Если
	модуль некорректно обрабатывает вес заказа - проверьте в первую очередь
	настройки торгового каталога в товаре.

8. ***Иконки для службы доставки.***

	Чтобы поставить службам доставки иконки, необходимо изменить шаблон оформления
	заказа, который (скорей всего) располагается по адресу:
	* Компонент "Одношаговое оформление заказа": ```<путь к шаблонам>/sale.order.ajax/<название используемого шаблона>/delivery.php```.
	* Компонент "Процедура оформления заказа": ```<путь к шаблонам>/sale.order.full/<название используемого шаблона>/step3.php```

	В файле необходимо найти место, где происходит сборка html доставок. 
	это место выглядит примерно так:
	```php
		foreach ($arDelivery["PROFILES"] as $profile_id => $arProfile) {
			/// ...
		}
	```

	Логотип можно вставить следующим способом:
	```php
		if ($delivery_id == 'ipolh_dpd') { //применяем только к доставкам DPD
			$deliveryImgURL='/path/to/image_'.$profile_id.'.png'; //путь к картинке
		}
	```

### Оформление и отправка заявки
После оформления заказа, с выбранной службой доставки DPD, в адм. части сайта
при просмотре заказа (***Магазин -> Заказы -> Нужный заказ***) стоновиться доступна
кнопка ***DPD доставка***. При нажатии на эту кнопку откроется окно создание 
заявки DPD. В открывшемся окне необходимо заполнить данные заявки. Модуль
проверит заполненность необходимых полей. По умолчанию поля будут заполнены
свойствами заказа согласно указаниям в настройках. 

Обратите внимание, что поле ***Тариф*** изначально содержит оптимальный тариф 
доставки для пользователя полученный при расчете стоимости (тариф с минимальной
стоимостью доставки). Вы можете изменить выбранный тариф на любой другой из
списка, таким образом отправлять из административной части можно заказ с любым
тарифом. При смене тарифа покажется оповещение о стоимости и сроках доставки для
выбранного тарифа.

Поле стоимости доставки импортируется только из заказа, и автоматически не
меняется (то есть, если вы сменили тариф - стоимость доставки для покупателя
останеться не изменной).

Так же можно изменить габариты заказа. Учтите, что стоимость (и, возможно, сроки)
доставки при этом могут изменяться, о чем будет сообщено во всплывающем окне.

Если заявка готова к отправке - нажмите клавишу "Создать". После оповещения, что
заявка сохранена, можно закрыть окно. Если при отравке возникнут ошибки, их можно
просмотреть в этом же окне после перезагрузки страницы.
Возможна отправка заявки, содержащей только один заказ (то есть только методом, описанным выше).

```Вниматие!``` Если необходимо отредактировать или удалить заявку на заказ,
отосланный через модуль, необходимо ее отменить. После отмены заявки, ее можно
отправить заново, но в этом случае необходимо обязательно изменить
***дату передачи груза в DPD***

## Дополнительные возможности

### Обновление информации о заявке
Опрос статусов заказов происходит каждые 10 минут. Если статус изменился - он
поменяется в таблице Заявок, а так же сменится статус заказа на выставленный в
настройках модуля (или не сменится, если он не выставлялся).

### Статусы заказов
Заявке может быть присвоен один из следующих статусов:
* ***NEW*** - Новый заказ, еще не отправлялся в DPD,
* ***OK*** - Успешно создан,
* ***OrderPending*** - Принят, но нуждается в ручной доработке сотрудником DPD,
* ***Canceled*** - Заказ отменен
* ***NotDone*** - Заказ отменен в процессе доставки
* ***OnTerminalPickup*** - Посылка находится на терминале приема отправления
* ***OnRoad***  - Посылка находится в пути (внутренняя перевозка DPD)
* ***OnTerminal*** - Посылка находится на транзитном терминале
* ***OnTerminalDelivery*** - Посылка находится на терминале доставки
* ***Delivering*** - Посылка выведена на доставку (передана курьеру)
* ***Delivered*** - Посылка доставлена получателю
* ***Lost*** - Посылка утеряна
* ***Problem*** - C посылкой возникла проблемная ситуация
* ***ReturnedFromDelivery*** - Посылка возвращена с курьерской доставки
* ***NewOrderByDPD*** - Оформлен новый заказ по инициативе DPD
* ***NewOrderByClient*** - Оформлен новый заказ по инициативе клиента

### Печать квитанции
Если заявка имеет статус OK (и выше) - значит, DPD может прислать файл с 
квитанцией для распечатки, аналогичный получаемому в личном кабинете.
Распечатать его можно либо в окне оформления заявки на странице заказа. 
Рекомендуется сохранять pdf-файл с квитанцией на компьютере, после чего - 
открывать его и распечатывать.

### Особенности расчета стоимости доставки
Стоимость доставки расчитывается с помощью калькулятора тарифов DPD, она же
отображается покупателю при оформлении заказа, причем при расчете стоимости
выбирается тариф с самой низкой ценой доставки из возможных (с учетом настроек модуля).

Стоимость доставки зависит от габаритов заказа: его размеров и веса. Если в
заказе несколько товаров - модуль считает их единой коробкой и выводит стоимость
доставки для этой упаковки. Все габариты берутся из настроек торгового каталога.
Если в заказе присутствуют товары с неуказанными габаритами или весом - то расчет
изначально производится без их учета. Для расчета стоимости доставки принимается
максимальное значение из расчитанных габаритов или габаритов указанных по 
умолчанию в настройках модуля. Таким образом, причина того, что заказ в модуле
весит больше, чем на сайте, в том, что в составе этого заказа есть товар с
неуказанными габаритами.

***Важно!*** Стоимость и сроки доставки рассчитываются на стороне API DPD и
могут отличаться при изменении габаритов или веса заказа.